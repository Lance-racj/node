"use strict";var e=Object.defineProperty,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,a=(t,n,o)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[n]=o;Object.defineProperty(exports,"__esModule",{value:!0}),exports[Symbol.toStringTag]="Module";var r=require("fast-memoize"),l=require("nanoid"),i=require("mitt"),s=require("@folmejs/core");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=c(r),p=c(i);const h=e=>new Promise(((t,n)=>{const o=new Image;o.decoding="async";const a=()=>{t(o),o.removeEventListener("load",a,!1)};o.addEventListener("load",a,!1),o.addEventListener("error",(()=>{n(`Frame "${e}" loading failed`),o.removeEventListener("error",a,!1)}),!1),o.src=e}));function y(){return"undefined"!=typeof window&&"OffscreenCanvas"in window&&"transferControlToOffscreen"in HTMLCanvasElement.prototype&&"createImageBitmap"in window}const u=new Blob([atob("dmFyIGU9e2V4cG9ydHM6e319O2Z1bmN0aW9uIHQoZSx0LHIsYSl7dmFyIGMsbj1udWxsPT0oYz1hKXx8Im51bWJlciI9PXR5cGVvZiBjfHwiYm9vbGVhbiI9PXR5cGVvZiBjP2E6cihhKSxzPXQuZ2V0KG4pO3JldHVybiB2b2lkIDA9PT1zJiYocz1lLmNhbGwodGhpcyxhKSx0LnNldChuLHMpKSxzfWZ1bmN0aW9uIHIoZSx0LHIpe3ZhciBhPUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywzKSxjPXIoYSksbj10LmdldChjKTtyZXR1cm4gdm9pZCAwPT09biYmKG49ZS5hcHBseSh0aGlzLGEpLHQuc2V0KGMsbikpLG59ZnVuY3Rpb24gYShlLHQscixhLGMpe3JldHVybiByLmJpbmQodCxlLGEsYyl9ZnVuY3Rpb24gYyhlLGMpe3JldHVybiBhKGUsdGhpcywxPT09ZS5sZW5ndGg/dDpyLGMuY2FjaGUuY3JlYXRlKCksYy5zZXJpYWxpemVyKX1mdW5jdGlvbiBuKCl7cmV0dXJuIEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50cyl9ZnVuY3Rpb24gcygpe3RoaXMuY2FjaGU9T2JqZWN0LmNyZWF0ZShudWxsKX1zLnByb3RvdHlwZS5oYXM9ZnVuY3Rpb24oZSl7cmV0dXJuIGUgaW4gdGhpcy5jYWNoZX0scy5wcm90b3R5cGUuZ2V0PWZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLmNhY2hlW2VdfSxzLnByb3RvdHlwZS5zZXQ9ZnVuY3Rpb24oZSx0KXt0aGlzLmNhY2hlW2VdPXR9O3ZhciBpPXtjcmVhdGU6ZnVuY3Rpb24oKXtyZXR1cm4gbmV3IHN9fTtlLmV4cG9ydHM9ZnVuY3Rpb24oZSx0KXt2YXIgcj10JiZ0LmNhY2hlP3QuY2FjaGU6aSxhPXQmJnQuc2VyaWFsaXplcj90LnNlcmlhbGl6ZXI6bjtyZXR1cm4odCYmdC5zdHJhdGVneT90LnN0cmF0ZWd5OmMpKGUse2NhY2hlOnIsc2VyaWFsaXplcjphfSl9LGUuZXhwb3J0cy5zdHJhdGVnaWVzPXt2YXJpYWRpYzpmdW5jdGlvbihlLHQpe3JldHVybiBhKGUsdGhpcyxyLHQuY2FjaGUuY3JlYXRlKCksdC5zZXJpYWxpemVyKX0sbW9uYWRpYzpmdW5jdGlvbihlLHIpe3JldHVybiBhKGUsdGhpcyx0LHIuY2FjaGUuY3JlYXRlKCksci5zZXJpYWxpemVyKX19O3ZhciBvPWUuZXhwb3J0cztmdW5jdGlvbiBsKGUsdCl7cmV0dXJuIG8oZSx7Y2FjaGU6e2NyZWF0ZTooKT0+KHtoYXM6ZT0+dC5oYXMoZSksZ2V0OmU9PnQuZ2V0KGUpLHNldDooZSxyKT0+dC5zZXQoZSxyKX0pfX0pfWNvbnN0IHU9bmV3IE1hcCxoPW5ldyBNYXA7bGV0IGY9bnVsbCxwPW51bGw7Y29uc3QgZz1sKChhc3luYyBlPT4oYXdhaXQgZmV0Y2goZSkpLmJsb2IoKSksdSksZD1sKChhc3luYyBlPT57Y29uc3QgdD1hd2FpdCBnKGUpO3JldHVybiBjcmVhdGVJbWFnZUJpdG1hcCh0KX0pLGgpO3NlbGYub25tZXNzYWdlPWFzeW5jKHtkYXRhOmV9KT0+e2NvbnN0e2lkOnQsYWN0aW9uOnJ9PWU7dHJ5e3N3aXRjaChyKXtjYXNlInJlZ2lzdGVyIjppZihmPWUuY2FudmFzLGYmJihwPWYuZ2V0Q29udGV4dCgiMmQiLHthbHBoYTplLmFscGhhfSkpLCFwKXRocm93IG5ldyBFcnJvcigiWW91ciBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgb2Zmc2NyZWVuIHJlbmRlcmluZyIpO2JyZWFrO2Nhc2UicHJlbG9hZCI6YXdhaXQgZyhlLnNyYyk7YnJlYWs7Y2FzZSJkcmF3IjppZighcHx8IWYpdGhyb3cgbmV3IEVycm9yKCJZb3Ugc2hvdWxkIGNhbGwgJ3JlZ2lzdGVyJyBiZWZvcmUgZHJhd2luZyIpO2NvbnN0e3NyYzp0fT1lLHt3aWR0aDpyLGhlaWdodDphfT1mLGM9YXdhaXQgZCh0KTtwLmNsZWFyUmVjdCgwLDAscixhKSxwLmRyYXdJbWFnZShjLDAsMCxyLGEpO2JyZWFrO2Nhc2UiZGVzdHJveSI6dS5jbGVhcigpLGguY2xlYXIoKX1zZWxmLnBvc3RNZXNzYWdlKHtpZDp0fSl9Y2F0Y2goYSl7c2VsZi5wb3N0TWVzc2FnZSh7aWQ6dCxlcnJvcjphfSl9fTsK")],{type:"text/javascript;charset=utf-8"});function m(){const e=(window.URL||window.webkitURL).createObjectURL(u);try{return new Worker(e)}finally{(window.URL||window.webkitURL).revokeObjectURL(e)}}function b(e){const r=new Map;return e.onmessage=({data:e})=>{const t=r.get(e.id);t&&(e.error?t.reject(e.error):t.resolve(e.return),r.delete(e.id))},function(i,s,c=[]){const d=l.nanoid();return e.postMessage(((e,r)=>{for(var l in r||(r={}))n.call(r,l)&&a(e,l,r[l]);if(t)for(var l of t(r))o.call(r,l)&&a(e,l,r[l]);return e})({id:d,action:i},s),c),new Promise(((e,t)=>{r.set(d,{reject:t,resolve:e})}))}}function Z(e,t,n){if(t){const t=b(new m),o=e.transferControlToOffscreen();t("register",{canvas:o,alpha:n},[o]);return{preload:async e=>{await t("preload",{src:e})},draw:async e=>{await t("draw",{src:e})},destroy:async()=>{await t("destroy")}}}{const t=e.getContext("2d",{alpha:n});if(!t)throw new Error("Your browser does not support canvas 2d context");const r=e.width,l=e.height,i=new Map,s=new Map,c=(o=h,a=i,d.default(o,{cache:{create:()=>({has:e=>a.has(e),get:e=>a.get(e),set:(e,t)=>a.set(e,t)})}}));return{draw:async e=>{const n=await c(e);t.clearRect(0,0,r,l),t.drawImage(n,0,0,r,l)},preload:async e=>{await c(e)},destroy:async()=>{i.clear(),s.clear()}}}var o,a}exports.createDrawer=Z,exports.createPlayer=function(e){const{container:t,frames:n,width:o,height:a,layout:r,objectFit:l="cover",objectPosition:i="center",chunkSize:c=10,fps:d=30,autoload:h=!0,lazyload:u=!0,autoplay:m=!1,loop:b=!1,yoyo:w=!1,parallel:Y=y(),alpha:f=!1}=e;let G;if("total"in n){G=[];for(let e=0;e<n.total;e++)G.push(n.iterator(e))}else G=n;const g=document.createElement("canvas");let W;if(g.width=1*o,g.height=1*a,g.style.cssText="\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n  ","intrinsic"!==r&&"responsive"!==r||(W=document.createElement("div"),W.className="ff-placeholder",s.setStyle(W,{paddingBottom:a/o*100+"%"}),t.append(W,g)),"fill"===r)s.setStyle(t,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});else{if("static"===t.style.position)throw new Error("Container position should be static");""===t.style.position&&s.setStyle(t,{position:"relative"})}"fixed"===r&&s.setStyle(t,{width:o+"px",height:a+"px"}),"intrinsic"===r&&s.setStyle(t,{maxWidth:o+"px"}),s.setStyle(g,{position:"absolute",left:0,top:0,width:"100%",height:"100%",objectFit:l,objectPosition:i}),t.appendChild(g);const X=Z(g,Y,f);let V=0;const L=s.createTimer(),v=p.default(),S=new Set;let x=!1,j=0,J=!1,K=!1;const I=async e=>{if(S.has(e))return;const t=Date.now();let n=!0;try{await X.preload(G[e])}catch(o){console.warn("Frame load failed",o),n=!1}finally{S.add(e);const o=Date.now();v.emit("frameloaded",{isSuccess:n,time:o-t,index:e,current:S.size,total:G.length,player:U}),S.size===G.length&&v.emit("loaded",{player:U,total:G.length})}},H=async()=>{x=!0;const e=function(e){const t=new Set([0,e-1]);for(let n=2;n<=e;n++){const o=Math.floor(e/2**n);for(let n=o;n<e;n+=o)t.add(n);if(t.size===e)break}return t}(G.length),t=[];for(const n of e)t.length<c||(await Promise.all(t),t.length=0),t.push(I(n));t.length&&await Promise.all(t)},z=async e=>{const t=Math.max(0,Math.min(G.length-1,Math.round(e)));j=t,S.has(t)&&(v.emit("tick",{player:U,frame:t}),await X.draw(G[t]))},N=()=>{V=0,K=!0,L.start(),v.emit("play",{player:U})},R=()=>{L.stop(),K=!1,v.emit("pause",{player:U})},F=()=>{J=!J};L.listen((e=>{V+=e;const t=G.length-1;if(V>1/d){V=0;const e=j+(J?-1:1);!function(e,t,n){return e>=t&&e<=n}(e,0,t)?b?w?F():z(J?t:0):R():z(e)}}));const P=new IntersectionObserver((([e])=>{const t=e.isIntersecting;!x&&t&&h&&u&&H(),t||L.stop(),t&&K&&L.start()}),{rootMargin:"10%"});P.observe(t);const U={get curFrame(){return j},get isReversed(){return J},get isPlaying(){return K},load:H,play:N,pause:R,reverse:F,pin:z,on:v.on.bind(v),off:v.off.bind(v),destroy:async()=>{await X.destroy(),P.disconnect(),L.stop(),v.all.clear(),g.remove(),W&&W.remove()}};return h&&!u&&H(),h&&m&&N(),I(0).then((()=>z(0))),U};
