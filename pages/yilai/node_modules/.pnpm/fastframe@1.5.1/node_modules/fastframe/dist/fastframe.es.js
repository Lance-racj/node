var e=Object.defineProperty,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,a=(t,n,o)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[n]=o;import i from"fast-memoize";import{nanoid as r}from"nanoid";import c from"mitt";import{setStyle as l,createTimer as s}from"@folmejs/core";const d=e=>new Promise(((t,n)=>{const o=new Image;o.decoding="async";const a=()=>{t(o),o.removeEventListener("load",a,!1)};o.addEventListener("load",a,!1),o.addEventListener("error",(()=>{n(`Frame "${e}" loading failed`),o.removeEventListener("error",a,!1)}),!1),o.src=e}));function p(){return"undefined"!=typeof window&&"OffscreenCanvas"in window&&"transferControlToOffscreen"in HTMLCanvasElement.prototype&&"createImageBitmap"in window}const h=new Blob([atob("dmFyIGU9e2V4cG9ydHM6e319O2Z1bmN0aW9uIHQoZSx0LHIsYSl7dmFyIGMsbj1udWxsPT0oYz1hKXx8Im51bWJlciI9PXR5cGVvZiBjfHwiYm9vbGVhbiI9PXR5cGVvZiBjP2E6cihhKSxzPXQuZ2V0KG4pO3JldHVybiB2b2lkIDA9PT1zJiYocz1lLmNhbGwodGhpcyxhKSx0LnNldChuLHMpKSxzfWZ1bmN0aW9uIHIoZSx0LHIpe3ZhciBhPUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywzKSxjPXIoYSksbj10LmdldChjKTtyZXR1cm4gdm9pZCAwPT09biYmKG49ZS5hcHBseSh0aGlzLGEpLHQuc2V0KGMsbikpLG59ZnVuY3Rpb24gYShlLHQscixhLGMpe3JldHVybiByLmJpbmQodCxlLGEsYyl9ZnVuY3Rpb24gYyhlLGMpe3JldHVybiBhKGUsdGhpcywxPT09ZS5sZW5ndGg/dDpyLGMuY2FjaGUuY3JlYXRlKCksYy5zZXJpYWxpemVyKX1mdW5jdGlvbiBuKCl7cmV0dXJuIEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50cyl9ZnVuY3Rpb24gcygpe3RoaXMuY2FjaGU9T2JqZWN0LmNyZWF0ZShudWxsKX1zLnByb3RvdHlwZS5oYXM9ZnVuY3Rpb24oZSl7cmV0dXJuIGUgaW4gdGhpcy5jYWNoZX0scy5wcm90b3R5cGUuZ2V0PWZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLmNhY2hlW2VdfSxzLnByb3RvdHlwZS5zZXQ9ZnVuY3Rpb24oZSx0KXt0aGlzLmNhY2hlW2VdPXR9O3ZhciBpPXtjcmVhdGU6ZnVuY3Rpb24oKXtyZXR1cm4gbmV3IHN9fTtlLmV4cG9ydHM9ZnVuY3Rpb24oZSx0KXt2YXIgcj10JiZ0LmNhY2hlP3QuY2FjaGU6aSxhPXQmJnQuc2VyaWFsaXplcj90LnNlcmlhbGl6ZXI6bjtyZXR1cm4odCYmdC5zdHJhdGVneT90LnN0cmF0ZWd5OmMpKGUse2NhY2hlOnIsc2VyaWFsaXplcjphfSl9LGUuZXhwb3J0cy5zdHJhdGVnaWVzPXt2YXJpYWRpYzpmdW5jdGlvbihlLHQpe3JldHVybiBhKGUsdGhpcyxyLHQuY2FjaGUuY3JlYXRlKCksdC5zZXJpYWxpemVyKX0sbW9uYWRpYzpmdW5jdGlvbihlLHIpe3JldHVybiBhKGUsdGhpcyx0LHIuY2FjaGUuY3JlYXRlKCksci5zZXJpYWxpemVyKX19O3ZhciBvPWUuZXhwb3J0cztmdW5jdGlvbiBsKGUsdCl7cmV0dXJuIG8oZSx7Y2FjaGU6e2NyZWF0ZTooKT0+KHtoYXM6ZT0+dC5oYXMoZSksZ2V0OmU9PnQuZ2V0KGUpLHNldDooZSxyKT0+dC5zZXQoZSxyKX0pfX0pfWNvbnN0IHU9bmV3IE1hcCxoPW5ldyBNYXA7bGV0IGY9bnVsbCxwPW51bGw7Y29uc3QgZz1sKChhc3luYyBlPT4oYXdhaXQgZmV0Y2goZSkpLmJsb2IoKSksdSksZD1sKChhc3luYyBlPT57Y29uc3QgdD1hd2FpdCBnKGUpO3JldHVybiBjcmVhdGVJbWFnZUJpdG1hcCh0KX0pLGgpO3NlbGYub25tZXNzYWdlPWFzeW5jKHtkYXRhOmV9KT0+e2NvbnN0e2lkOnQsYWN0aW9uOnJ9PWU7dHJ5e3N3aXRjaChyKXtjYXNlInJlZ2lzdGVyIjppZihmPWUuY2FudmFzLGYmJihwPWYuZ2V0Q29udGV4dCgiMmQiLHthbHBoYTplLmFscGhhfSkpLCFwKXRocm93IG5ldyBFcnJvcigiWW91ciBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgb2Zmc2NyZWVuIHJlbmRlcmluZyIpO2JyZWFrO2Nhc2UicHJlbG9hZCI6YXdhaXQgZyhlLnNyYyk7YnJlYWs7Y2FzZSJkcmF3IjppZighcHx8IWYpdGhyb3cgbmV3IEVycm9yKCJZb3Ugc2hvdWxkIGNhbGwgJ3JlZ2lzdGVyJyBiZWZvcmUgZHJhd2luZyIpO2NvbnN0e3NyYzp0fT1lLHt3aWR0aDpyLGhlaWdodDphfT1mLGM9YXdhaXQgZCh0KTtwLmNsZWFyUmVjdCgwLDAscixhKSxwLmRyYXdJbWFnZShjLDAsMCxyLGEpO2JyZWFrO2Nhc2UiZGVzdHJveSI6dS5jbGVhcigpLGguY2xlYXIoKX1zZWxmLnBvc3RNZXNzYWdlKHtpZDp0fSl9Y2F0Y2goYSl7c2VsZi5wb3N0TWVzc2FnZSh7aWQ6dCxlcnJvcjphfSl9fTsK")],{type:"text/javascript;charset=utf-8"});function y(){const e=(window.URL||window.webkitURL).createObjectURL(h);try{return new Worker(e)}finally{(window.URL||window.webkitURL).revokeObjectURL(e)}}function m(e){const i=new Map;return e.onmessage=({data:e})=>{const t=i.get(e.id);t&&(e.error?t.reject(e.error):t.resolve(e.return),i.delete(e.id))},function(c,l,s=[]){const d=r();return e.postMessage(((e,i)=>{for(var r in i||(i={}))n.call(i,r)&&a(e,r,i[r]);if(t)for(var r of t(i))o.call(i,r)&&a(e,r,i[r]);return e})({id:d,action:c},l),s),new Promise(((e,t)=>{i.set(d,{reject:t,resolve:e})}))}}function u(e,t,n){if(t){const t=m(new y),o=e.transferControlToOffscreen();t("register",{canvas:o,alpha:n},[o]);return{preload:async e=>{await t("preload",{src:e})},draw:async e=>{await t("draw",{src:e})},destroy:async()=>{await t("destroy")}}}{const t=e.getContext("2d",{alpha:n});if(!t)throw new Error("Your browser does not support canvas 2d context");const a=e.width,r=e.height,c=new Map,l=new Map,s=(o=c,i(d,{cache:{create:()=>({has:e=>o.has(e),get:e=>o.get(e),set:(e,t)=>o.set(e,t)})}}));return{draw:async e=>{const n=await s(e);t.clearRect(0,0,a,r),t.drawImage(n,0,0,a,r)},preload:async e=>{await s(e)},destroy:async()=>{c.clear(),l.clear()}}}var o}function b(e){const{container:t,frames:n,width:o,height:a,layout:i,objectFit:r="cover",objectPosition:d="center",chunkSize:h=10,fps:y=30,autoload:m=!0,lazyload:b=!0,autoplay:Z=!1,loop:w=!1,yoyo:Y=!1,parallel:G=p(),alpha:f=!1}=e;let g;if("total"in n){g=[];for(let e=0;e<n.total;e++)g.push(n.iterator(e))}else g=n;const W=document.createElement("canvas");let X;if(W.width=1*o,W.height=1*a,W.style.cssText="\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n  ","intrinsic"!==i&&"responsive"!==i||(X=document.createElement("div"),X.className="ff-placeholder",l(X,{paddingBottom:a/o*100+"%"}),t.append(X,W)),"fill"===i)l(t,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});else{if("static"===t.style.position)throw new Error("Container position should be static");""===t.style.position&&l(t,{position:"relative"})}"fixed"===i&&l(t,{width:o+"px",height:a+"px"}),"intrinsic"===i&&l(t,{maxWidth:o+"px"}),l(W,{position:"absolute",left:0,top:0,width:"100%",height:"100%",objectFit:r,objectPosition:d}),t.appendChild(W);const V=u(W,G,f);let L=0;const v=s(),J=c(),j=new Set;let x=!1,K=0,I=!1,H=!1;const S=async e=>{if(j.has(e))return;const t=Date.now();let n=!0;try{await V.preload(g[e])}catch(o){console.warn("Frame load failed",o),n=!1}finally{j.add(e);const o=Date.now();J.emit("frameloaded",{isSuccess:n,time:o-t,index:e,current:j.size,total:g.length,player:P}),j.size===g.length&&J.emit("loaded",{player:P,total:g.length})}},z=async()=>{x=!0;const e=function(e){const t=new Set([0,e-1]);for(let n=2;n<=e;n++){const o=Math.floor(e/2**n);for(let n=o;n<e;n+=o)t.add(n);if(t.size===e)break}return t}(g.length),t=[];for(const n of e)t.length<h||(await Promise.all(t),t.length=0),t.push(S(n));t.length&&await Promise.all(t)},N=async e=>{const t=Math.max(0,Math.min(g.length-1,Math.round(e)));K=t,j.has(t)&&(J.emit("tick",{player:P,frame:t}),await V.draw(g[t]))},R=()=>{L=0,H=!0,v.start(),J.emit("play",{player:P})},F=()=>{v.stop(),H=!1,J.emit("pause",{player:P})},U=()=>{I=!I};v.listen((e=>{L+=e;const t=g.length-1;if(L>1/y){L=0;const e=K+(I?-1:1);!function(e,t,n){return e>=t&&e<=n}(e,0,t)?w?Y?U():N(I?t:0):F():N(e)}}));const C=new IntersectionObserver((([e])=>{const t=e.isIntersecting;!x&&t&&m&&b&&z(),t||v.stop(),t&&H&&v.start()}),{rootMargin:"10%"});C.observe(t);const P={get curFrame(){return K},get isReversed(){return I},get isPlaying(){return H},load:z,play:R,pause:F,reverse:U,pin:N,on:J.on.bind(J),off:J.off.bind(J),destroy:async()=>{await V.destroy(),C.disconnect(),v.stop(),J.all.clear(),W.remove(),X&&X.remove()}};return m&&!b&&z(),m&&Z&&R(),S(0).then((()=>N(0))),P}export{u as createDrawer,b as createPlayer};
